# Apache Configuration for Monastery Healthcare and Donation Management System
# .htaccess file for URL rewriting and security

# Enable mod_rewrite
RewriteEngine On

# Prevent direct access to configuration files
<Files "config.php">
    Order allow,deny
    Deny from all
</Files>

<Files "*.sql">
    Order allow,deny
    Deny from all
</Files>

# Prevent access to sensitive directories
RedirectMatch 404 /\.git
RedirectMatch 404 /includes/config\.php$
RedirectMatch 404 /database/.*\.sql$

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy (adjust as needed)
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: https:;"
</IfModule>

# Hide server information
ServerTokens Prod
<IfModule mod_headers.c>
    Header unset Server
</IfModule>

# Prevent access to .htaccess file itself
<Files ".htaccess">
    Order allow,deny
    Deny from all
</Files>

# Custom error pages
ErrorDocument 404 /error/404.php
ErrorDocument 403 /error/403.php
ErrorDocument 500 /error/500.php

# URL Rewriting Rules
RewriteEngine On

# Force HTTPS (uncomment in production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Remove .php extension from URLs
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^([^\.]+)$ $1.php [NC,L]

# Redirect index.php to root
RewriteRule ^index\.php$ / [R=301,L]

# Admin area routing
RewriteRule ^admin/?$ admin/index.php [L]
RewriteRule ^admin/([^/]+)/?$ admin/$1.php [L]
RewriteRule ^admin/([^/]+)/([^/]+)/?$ admin/$1/$2.php [L]

# Monk area routing
RewriteRule ^monk/?$ monk/index.php [L]
RewriteRule ^monk/([^/]+)/?$ monk/$1.php [L]

# Doctor area routing
RewriteRule ^doctor/?$ doctor/index.php [L]
RewriteRule ^doctor/([^/]+)/?$ doctor/$1.php [L]

# Donator area routing
RewriteRule ^donator/?$ donator/index.php [L]
RewriteRule ^donator/([^/]+)/?$ donator/$1.php [L]

# Authentication routing
RewriteRule ^login/?$ auth/login.php [L]
RewriteRule ^logout/?$ auth/logout.php [L]
RewriteRule ^register/?$ auth/register.php [L]

# File Upload Security
<FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|jsp|asp|sh|cgi)$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Prevent execution of PHP files in upload directories
<Directory "uploads">
    php_flag engine off
    Options -ExecCGI
    AddHandler text/plain .php .phtml .php3 .php4 .php5 .pl .py .jsp .asp .sh .cgi
</Directory>

# File size limits
LimitRequestBody 10485760  # 10MB limit

# Compress text files
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# Browser Caching
<IfModule mod_expires.c>
    ExpiresActive on
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/ico "access plus 1 month"
    ExpiresByType image/icon "access plus 1 month"
    ExpiresByType text/x-icon "access plus 1 month"
    ExpiresByType application/x-icon "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
</IfModule>

# Prevent hotlinking
RewriteCond %{HTTP_REFERER} !^$
RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
RewriteRule \.(jpe?g|png|gif|bmp)$ - [F]

# PHP Configuration (if allowed)
<IfModule mod_php8.c>
    # Hide PHP errors in production
    php_flag display_errors Off
    php_flag log_errors On
    php_value error_log logs/php_errors.log
    
    # Security settings
    php_flag expose_php Off
    php_flag allow_url_fopen Off
    php_flag allow_url_include Off
    
    # Session security
    php_value session.cookie_httponly 1
    php_value session.cookie_secure 1
    php_value session.use_only_cookies 1
    
    # File upload limits
    php_value upload_max_filesize "5M"
    php_value post_max_size "10M"
    php_value max_execution_time 300
    php_value memory_limit "128M"
</IfModule>

# Protect sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|sql)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Prevent direct access to PHP includes
RewriteRule ^includes/ - [F,L]

# Block suspicious requests
RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|Ãª|"|;|\?|\*|=$).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*("|'|<|>|\|).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(%24&x).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(%0|%A|%B|%C|%D|%E|%F|127\.0).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(globals|encode|localhost|loopback).* [NC,OR]
RewriteCond %{QUERY_STRING} ^.*(request|select|concat|union|declare).* [NC]
RewriteRule ^(.*)$ index.php [F,L]